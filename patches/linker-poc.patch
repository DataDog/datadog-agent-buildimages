From 9c58cb4ada40e0a5b2b1e117e1afb31f20d2f91b Mon Sep 17 00:00:00 2001
From: Paul Cacheux <paul.cacheux@datadoghq.com>
Date: Mon, 2 Dec 2024 21:06:55 +0100
Subject: [PATCH 1/2] reflect: print reflected method

---
 src/reflect/type.go | 27 +++++++++++++++++++++++++++
 1 file changed, 27 insertions(+)

diff --git a/src/reflect/type.go b/src/reflect/type.go
index 89c5015530..39f94d9075 100644
--- a/src/reflect/type.go
+++ b/src/reflect/type.go
@@ -619,10 +619,12 @@ func (t *rtype) Method(i int) (m Method) {
 	m.Func = Value{&mt.(*rtype).t, fn, fl}
 
 	m.Index = i
+	addReflectName(m.Name)
 	return m
 }
 
 func (t *rtype) MethodByName(name string) (m Method, ok bool) {
+	addReflectName(name)
 	if t.Kind() == Interface {
 		tt := (*interfaceType)(unsafe.Pointer(t))
 		return tt.MethodByName(name)
@@ -851,6 +853,7 @@ func (t *interfaceType) Method(i int) (m Method) {
 	}
 	m.Type = toType(t.typeOff(p.Typ))
 	m.Index = i
+	addReflectName(m.Name)
 	return
 }
 
@@ -859,6 +862,7 @@ func (t *interfaceType) NumMethod() int { return len(t.Methods) }
 
 // MethodByName method with the given name in the type's method set.
 func (t *interfaceType) MethodByName(name string) (m Method, ok bool) {
+	addReflectName(name)
 	if t == nil {
 		return
 	}
@@ -2883,3 +2887,26 @@ func addTypeBits(bv *bitVector, offset uintptr, t *abi.Type) {
 func TypeFor[T any]() Type {
 	return TypeOf((*T)(nil)).Elem()
 }
+
+var (
+	rmn                  sync.Mutex
+	reflectedMethodNames = map[string]struct{}{}
+)
+
+func addReflectName(name string) {
+	rmn.Lock()
+	defer rmn.Unlock()
+
+	reflectedMethodNames[name] = struct{}{}
+}
+
+func GetAllReflectedMethodNames() []string {
+	rmn.Lock()
+	defer rmn.Unlock()
+
+	var names []string
+	for name := range reflectedMethodNames {
+		names = append(names, name)
+	}
+	return names
+}
-- 
2.47.1


From a9ef7acc40851c412e6aceb8275354445bdf3821 Mon Sep 17 00:00:00 2001
From: Paul Cacheux <paul.cacheux@datadoghq.com>
Date: Mon, 2 Dec 2024 15:34:54 +0100
Subject: [PATCH 2/2] deadcode: allow removal of more code in ld deadcode pass

---
 src/cmd/link/internal/ld/deadcode.go | 23 ++++++++++++++++++++++-
 src/cmd/link/internal/ld/main.go     |  1 +
 2 files changed, 23 insertions(+), 1 deletion(-)

diff --git a/src/cmd/link/internal/ld/deadcode.go b/src/cmd/link/internal/ld/deadcode.go
index 70b4a7ca30..964ec81ed4 100644
--- a/src/cmd/link/internal/ld/deadcode.go
+++ b/src/cmd/link/internal/ld/deadcode.go
@@ -12,6 +12,7 @@ import (
 	"cmd/link/internal/sym"
 	"fmt"
 	"internal/buildcfg"
+	"slices"
 	"strings"
 	"unicode"
 )
@@ -445,7 +446,9 @@ func deadcode(ctxt *Link) {
 		// in the last pass.
 		rem := d.markableMethods[:0]
 		for _, m := range d.markableMethods {
-			if (d.reflectSeen && (m.isExported() || d.dynlink)) || d.ifaceMethod[m.m] || d.genericIfaceMethod[m.m.name] {
+			if d.reflectSeen && (m.isExported() || d.dynlink) && !d.reportDeadMethod(m) {
+				d.markMethod(m)
+			} else if d.ifaceMethod[m.m] || d.genericIfaceMethod[m.m.name] {
 				d.markMethod(m)
 			} else {
 				rem = append(rem, m)
@@ -464,6 +467,24 @@ func deadcode(ctxt *Link) {
 	}
 }
 
+var methodsToKeep []string
+
+func keepYsym(name string) {
+	methodsToKeep = append(methodsToKeep, name)
+}
+
+func (d *deadcodePass) reportDeadMethod(m methodref) bool {
+	if len(methodsToKeep) == 0 {
+		return false
+	}
+
+	if slices.Contains(methodsToKeep, m.m.name) {
+		return false
+	}
+
+	return true
+}
+
 // methodsig is a typed method signature (name + type).
 type methodsig struct {
 	name string
diff --git a/src/cmd/link/internal/ld/main.go b/src/cmd/link/internal/ld/main.go
index feb4ba5c17..a13c17e37a 100644
--- a/src/cmd/link/internal/ld/main.go
+++ b/src/cmd/link/internal/ld/main.go
@@ -194,6 +194,7 @@ func Main(arch *sys.Arch, theArch Arch) {
 	objabi.Flagfn1("L", "add specified `directory` to library path", func(a string) { Lflag(ctxt, a) })
 	objabi.AddVersionFlag() // -V
 	objabi.Flagfn1("X", "add string value `definition` of the form importpath.name=value", func(s string) { addstrdata1(ctxt, s) })
+	objabi.Flagfn1("Y", "add method name to keep from deadcode elimination", func(s string) { keepYsym(s) })
 	objabi.Flagcount("v", "print link trace", &ctxt.Debugvlog)
 	objabi.Flagfn1("importcfg", "read import configuration from `file`", ctxt.readImportCfg)
 
-- 
2.47.1

