---
trigger_build_kernels:
  stage: test
  needs:
    - job: build_kernel_version_testing_x64
    - job: build_kernel_version_testing_arm64
  rules:
    - when: manual
      allow_failure: true
  # Pass variables to the child pipeline
  variables:
    PARENT_EXTRA_KCONFIG_VERSION: $EXTRA_KCONFIG_VERSION
    PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  trigger:
    include:
      - local: .gitlab/kernel_version_testing.yml
    strategy: depend

trigger_tests:
  stage: test
  rules:
    - when: manual
      allow_failure: true
  variables:
    RUN_KITCHEN_TESTS: "false"
    BUCKET_BRANCH: "dev"
    DATADOG_AGENT_BUILDIMAGES: "v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}"
    DATADOG_AGENT_BUILDIMAGES_SUFFIX: "${ECR_TEST_ONLY}"
    DATADOG_AGENT_WINBUILDIMAGES_SUFFIX: "${ECR_TEST_ONLY}"
    DATADOG_AGENT_WINBUILDIMAGES: "v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}"
    DATADOG_AGENT_ARMBUILDIMAGES_SUFFIX: "${ECR_TEST_ONLY}"
    DATADOG_AGENT_ARMBUILDIMAGES: "v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}"
  trigger:
    project: DataDog/datadog-agent
    strategy: depend

push_to_datadog_agent:
  stage: test
  tags: ["arch:amd64"]
  # TODO: This is not great, we probably should not rely on _test_only images but as we don't push a `latest` tag for validated images we don't really have a choice.
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$ECR_TEST_ONLY:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}
  dependencies: [] # do not download artifacts from other jobs
  needs: [build_multiarch] # wait for the multiarch image to be built as it is used for this job's execution environment
  variables:
    REF: main
    BRANCH: buildimages/$CI_COMMIT_BRANCH
    IMAGES_ID: v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}
  id_tokens:
    DDOCTOSTS_ID_TOKEN:
      aud: dd-octo-sts
  before_script:
    # Get a restricted-permissions token for datadog-agent repository
    - dd-octo-sts version
    - dd-octo-sts token --scope DataDog/ishirui-test --policy self.buildimages-ci.push-to-datadog-agent > token.txt
  script:
    - source /root/.bashrc
    - set -o pipefail
    # Get the current go version from the go.env file
    - >
      for line in $(cat go.env); do
        export $line
      done
    - export DDA_VERSION=$(grep DDA_VERSION dda.env | awk -F= '/^DDA_VERSION=/ {print $2}')
    - pip install "dda==${DDA_VERSION}"
    - dda -v self dep sync -f legacy-build
    - export GITHUB_TOKEN=$(cat token.txt)
    - dda run update agent-build-images "$IMAGES_ID" "$BRANCH" --ref "$REF" --test-version
  after_script:
    # Revoke the token after usage
    - dd-octo-sts revoke -t $(cat token.txt)
