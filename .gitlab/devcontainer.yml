variables:
  BUILD_STABLE_REGISTRY: registry.ddbuild.io
  CI_IMAGE_REPO: "${BUILD_STABLE_REGISTRY}/ci/datadog-agent-devenv"
  CI_REGISTRY_IMAGE: "${BUILD_STABLE_REGISTRY}/ci/datadog-agent-devenv"
  CI_REGISTRY_IMAGE_TEST: "${BUILD_STABLE_REGISTRY}/ci/datadog-agent-devenv-test"

lint_devcontainer:
  stage: devcontainer
  needs: []
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/images:v26997867-ebc48a76
  script:
    - hadolint devcontainer/Dockerfile
  tags: ["arch:amd64"]

build_devcontainer:
  stage: devcontainer
  needs: [lint_devcontainer]
  tags: ["arch:amd64"]
  image: $BUILD_STABLE_REGISTRY/images/docker:27.3.1
  # Build the image for both AMD64 and ARM64
  # This allows us to build amd64 agent images on arm64 machines
  parallel:
    matrix:
      - PLATFORM: [amd64, arm64]
  script:
    - GO_VERSION_ARG=$(grep GO_VERSION go.env | sed -e 's/^/--build-arg /' | tr '\n' ' ')
    - DDA_VERSION_ARG="--build-arg $(grep DDA_VERSION dda.env)"
    - docker buildx build $GO_VERSION_ARG $DDA_VERSION_ARG --push --no-cache --platform linux/${PLATFORM} --tag ${CI_REGISTRY_IMAGE_TEST}:${CI_COMMIT_SHORT_SHA}-${PLATFORM} --tag ${CI_REGISTRY_IMAGE_TEST}:${CI_COMMIT_SHA:0:12}-${PLATFORM} -f devcontainer/Dockerfile .

test_devcontainer:
  stage: devcontainer
  needs: [build_devcontainer]
  tags: ["arch:amd64"]
  parallel:
    matrix:
      - PLATFORM: [amd64, arm64]
  image: ${CI_REGISTRY_IMAGE_TEST}:${CI_COMMIT_SHORT_SHA}-${PLATFORM}
  script:
    - dda --version

release_devcontainer:
  image: ${BUILD_STABLE_REGISTRY}/images/docker:27.3.1
  tags: ["arch:amd64"]
  stage: devcontainer
  needs: [build_devcontainer]
  parallel:
    matrix:
      - PLATFORM: [amd64, arm64]
  script:
    - crane copy ${CI_REGISTRY_IMAGE_TEST}:${CI_COMMIT_SHORT_SHA}-${PLATFORM} ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA:0:12}-${PLATFORM}
    - crane tag ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA:0:12}-${PLATFORM} ${CI_REGISTRY_IMAGE}:latest-${PLATFORM}
    - crane tag ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA:0:12}-${PLATFORM} ${CI_REGISTRY_IMAGE}:1-${PLATFORM}
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
